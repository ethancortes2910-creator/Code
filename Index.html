<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>Clash-like 3D Final</title>
<style>
body{margin:0;overflow:hidden;background:#000;font-family:Arial}
#hud{
position:absolute;top:10px;left:10px;
background:rgba(0,0,0,.7);
padding:10px;border-radius:10px;color:white
}
button{padding:8px;margin:4px;border:none;border-radius:6px}
#end{display:none;position:absolute;inset:0;
background:rgba(0,0,0,.8);color:white;
align-items:center;justify-content:center;font-size:32px}
</style>
</head>
<body>

<div id="hud">
<button onclick="mode='build'">Builder</button>
<button onclick="mode='attack'">Attack</button><br>
<button onclick="spawnTroop('light')">Troupe</button>
<button onclick="spawnTroop('heavy')">GÃ©ant</button>
<button onclick="spell()">Sort</button>
</div>

<div id="end"></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.155/build/three.min.js"></script>
<script>
let mode="build";
const scene=new THREE.Scene();
scene.background=new THREE.Color(0x87ceeb);

const camera=new THREE.PerspectiveCamera(55,innerWidth/innerHeight,0.1,1000);
camera.position.set(18,22,18);
camera.lookAt(0,0,0);

const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio,1.5));
document.body.appendChild(renderer.domElement);

/* Lights */
scene.add(new THREE.AmbientLight(0xffffff,.6));
const sun=new THREE.DirectionalLight(0xffffff,1);
sun.position.set(20,30,10);
scene.add(sun);

/* Ground */
const ground=new THREE.Mesh(
new THREE.PlaneGeometry(50,50),
new THREE.MeshStandardMaterial({color:0x4caf50})
);
ground.rotation.x=-Math.PI/2;
scene.add(ground);

/* Arrays */
const buildings=[],troops=[],shots=[];

/* Building */
function addBuilding(x,z,type="canon"){
const b=new THREE.Mesh(
new THREE.BoxGeometry(3,3,3),
new THREE.MeshStandardMaterial({color:type=="canon"?0x555555:0x8b4513})
);
b.position.set(x,1.5,z);
b.userData={hp:120,cd:0,type};
scene.add(b);
buildings.push(b);
}

/* Touch build */
window.addEventListener("touchstart",()=>{
if(mode!=="build")return;
addBuilding((Math.random()*20)-10,(Math.random()*20)-10,"canon");
});

/* Troops */
function spawnTroop(type){
if(mode!=="attack")return;
const t=new THREE.Mesh(
new THREE.CapsuleGeometry(.4,type=="heavy"?1.4:1,4,8),
new THREE.MeshStandardMaterial({color:type=="heavy"?0xaa0000:0xff4444})
);
t.position.set(-20,1,-20);
t.userData={
hp:type=="heavy"?80:40,
speed:type=="heavy"?.03:.06,
damage:type=="heavy"?1:.6,
target:null
};
scene.add(t);
troops.push(t);
}

/* Spell */
function spell(){
const s=new THREE.Mesh(
new THREE.SphereGeometry(1.2,16,16),
new THREE.MeshStandardMaterial({color:0xff6600,transparent:true,opacity:.8})
);
s.position.set(0,1,0);
scene.add(s);
troops.forEach(t=>{
if(t.position.distanceTo(s.position)<5)t.userData.hp-=15;
});
let life=30;
(function fx(){
life--;s.scale.multiplyScalar(1.05);
if(life>0)requestAnimationFrame(fx);
else scene.remove(s);
})();
}

/* Game Loop */
function animate(){
requestAnimationFrame(animate);

/* Defense AI */
buildings.forEach(b=>{
b.userData.cd--;
if(b.userData.cd<=0 && troops.length){
const t=troops[0];
const p=new THREE.Mesh(
new THREE.SphereGeometry(.2),
new THREE.MeshBasicMaterial({color:0x000})
);
p.position.copy(b.position);
p.userData={target:t};
scene.add(p);
shots.push(p);
b.userData.cd=50;
}
});

/* Shots */
shots.forEach((s,i)=>{
const t=s.userData.target;
if(!t)return;
s.position.lerp(t.position,.1);
if(s.position.distanceTo(t.position)<.5){
t.userData.hp-=5;
scene.remove(s);shots.splice(i,1);
}
});

/* Troop AI */
troops.forEach((t,i)=>{
if(!t.userData.target && buildings.length)
t.userData.target=buildings[0];
const b=t.userData.target;
if(b){
t.position.lerp(b.position,t.userData.speed);
if(t.position.distanceTo(b.position)<2){
b.userData.hp-=t.userData.damage;
if(b.userData.hp<=0){
scene.remove(b);
buildings.splice(buildings.indexOf(b),1);
t.userData.target=null;
}
}
}
if(t.userData.hp<=0){
scene.remove(t);troops.splice(i,1);
}
});

/* Victory */
if(!buildings.length && mode==="attack"){
document.getElementById("end").style.display="flex";
document.getElementById("end").innerText="VICTOIRE";
}

renderer.render(scene,camera);
}
animate();

/* Resize */
window.addEventListener("resize",()=>{
camera.aspect=innerWidth/innerHeight;
camera.updateProjectionMatrix();
renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html> 
